<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flight Baggage & LB Monitor</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#eef1f6; --card:#ffffff; --line:#d8dde6; --text:#0f172a;
      --blue:#2f6fed;
    }
    body{font-family:system-ui,Segoe UI,Arial; background:var(--bg); color:var(--text); margin:0; padding:18px;}
    .header{background:var(--card); padding:14px 16px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); margin-bottom:12px;}
    h2{margin:0 0 6px 0;}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      background:var(--blue); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer;
      font-weight:600;
    }
    .tabs{display:flex; gap:8px; margin-top:10px;}
    .tab{
      padding:6px 12px; border-radius:999px; background:#e5e9f2; cursor:pointer; font-weight:600; font-size:14px;
    }
    .tab.active{background:var(--blue); color:white;}
    .table-wrap{
      background:var(--card); border-radius:12px; padding:10px; box-shadow:0 1px 3px rgba(0,0,0,.06);
      overflow:auto;
    }
    table{border-collapse:collapse; min-width:1400px; width:100%;}
    thead th{
      position:sticky; top:0; background:#dbe7ff; z-index:2;
      font-size:13px; padding:8px 6px; border-bottom:1px solid var(--line); text-align:center;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      font-size:13px; padding:6px 6px; text-align:center; white-space:nowrap;
    }

    /* inputs */
    input[type="number"], input[type="text"], input[type="time"]{
      width:70px; padding:4px 6px; font-size:13px; border:1px solid #c9ced8; border-radius:6px; text-align:center; background:#f9fafb;
    }
    input.wide-text{width:180px; text-align:left;}
    input.mid-text{width:120px;}
    input.time{width:86px;}

    /* خلي الأعمدة الضيقة مثل الصورة اليمين */
    .tiny { width:46px !important; }
    .small { width:58px !important; }
    .col-uld-bc-plt-d-w input { width:46px; } /* ULD/BC/PLT/D/W */
  </style>
</head>
<body>

  <div class="header">
    <h2>Flight Baggage & LB Monitor</h2>
    <div class="controls">
      <button id="refreshBtn" class="btn">Refresh data</button>
      <div id="countInfo">Flights: 0</div>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>FLT</th>
          <th>TEP</th>
          <th>STA</th>
          <th>ATA</th>
          <th>BDY</th>
          <th>TAR</th>
          <th>ORG</th>
          <th>Belt</th>
          <th>F ULD</th>
          <th>F BAG</th>
          <th>L ULD</th>
          <th>L BAG</th>

          <th>ULD</th>
          <th>BC</th>
          <th>PLT</th>
          <th>D</th>
          <th>W</th>

          <th>Terminated bags</th>
          <th>Domestic transit</th>
          <th>International transit</th>

          <th>Drop list remark 1</th>
          <th>Drop list remark 2</th>
          <th>Drop list remark 3</th>
          <th>Additional remark</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/*** 1) حط معلوماتك هنا ***/
const SUPABASE_URL = "PUT_YOUR_SUPABASE_URL_HERE";
const SUPABASE_KEY = "PUT_YOUR_SUPABASE_ANON_KEY_HERE";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/*** 2) إعدادات عامة ***/
const terminals = ["ALL", "T1", "T3", "T4"];
let activeTerminal = "ALL";
let flights = [];

/*** Helpers ***/
const fmtTime = (ts) => {
  if(!ts) return "";
  const d = new Date(ts);
  if(Number.isNaN(d.getTime())) return "";
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
};

// يصنع Timestamp بنفس تاريخ الرحلة أو نفس تاريخ القيمة القديمة
const applyTimeToTimestamp = (oldTs, timeStr, flightDateStr) => {
  if(!timeStr) return null;
  let baseDate = null;

  if(oldTs){
    const dOld = new Date(oldTs);
    if(!Number.isNaN(dOld.getTime())) baseDate = dOld;
  }
  if(!baseDate && flightDateStr){
    const dFd = new Date(flightDateStr);
    if(!Number.isNaN(dFd.getTime())) baseDate = dFd;
  }
  if(!baseDate){
    baseDate = new Date(); // fallback
  }

  const [hh, mm] = timeStr.split(":").map(Number);
  baseDate.setHours(hh, mm, 0, 0);
  return baseDate.toISOString();
};

async function updateCell(id, patch){
  const { error } = await supabase.from("flights").update(patch).eq("id", id);
  if(error){
    console.error(error);
    alert("فشل الحفظ: " + error.message);
  }
}

/*** Fetch data ***/
async function loadFlights(){
  let q = supabase.from("flights").select(`
    id,
    flt, tep, sta, ata, bdy, tar, org, belt,
    f_uld, f_bag, l_uld, l_bag,
    uld, bc, plt, d, w,
    terminated_bags, domestic_transit, international_transit,
    drop_list_remark1, drop_list_remark2, drop_list_remark3,
    additional_remark, flight_date, terminal
  `).order("sta");

  if(activeTerminal !== "ALL"){
    q = q.eq("terminal", activeTerminal);
  }

  const { data, error } = await q;
  if(error){ console.error(error); alert(error.message); return; }

  flights = data || [];
  renderTable();
}

/*** Render ***/
function renderTable(){
  document.getElementById("countInfo").textContent =
    `Flights: ${flights.length} (${activeTerminal === "ALL" ? "ALL terminals" : "Terminal " + activeTerminal})`;

  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";

  for(const f of flights){
    const tr = document.createElement("tr");

    const tdText = (v) => {
      const td = document.createElement("td");
      td.textContent = v ?? "";
      return td;
    };

    tr.appendChild(tdText(f.flt));
    tr.appendChild(tdText(f.tep));
    tr.appendChild(tdText(fmtTime(f.sta)));
    tr.appendChild(tdText(fmtTime(f.ata)));
    tr.appendChild(tdText(f.bdy));
    tr.appendChild(tdText(f.tar));
    tr.appendChild(tdText(f.org));
    tr.appendChild(tdText(f.belt));

    // Time inputs: F ULD / F BAG / L ULD / L BAG
    tr.appendChild(timeInputCell(f, "f_uld"));
    tr.appendChild(timeInputCell(f, "f_bag"));
    tr.appendChild(timeInputCell(f, "l_uld"));
    tr.appendChild(timeInputCell(f, "l_bag"));

    // tiny numeric inputs ULD BC PLT D W
    tr.appendChild(numInputCell(f, "uld", "tiny col-uld-bc-plt-d-w"));
    tr.appendChild(numInputCell(f, "bc",  "tiny col-uld-bc-plt-d-w"));
    tr.appendChild(numInputCell(f, "plt", "tiny col-uld-bc-plt-d-w"));
    tr.appendChild(numInputCell(f, "d",   "tiny col-uld-bc-plt-d-w"));
    tr.appendChild(numInputCell(f, "w",   "tiny col-uld-bc-plt-d-w"));

    tr.appendChild(numInputCell(f, "terminated_bags", "small"));
    tr.appendChild(numInputCell(f, "domestic_transit", "small"));
    tr.appendChild(numInputCell(f, "international_transit", "small"));

    tr.appendChild(textInputCell(f, "drop_list_remark1", "mid-text"));
    tr.appendChild(textInputCell(f, "drop_list_remark2", "mid-text"));
    tr.appendChild(textInputCell(f, "drop_list_remark3", "mid-text"));
    tr.appendChild(textInputCell(f, "additional_remark", "wide-text"));

    tr.appendChild(tdText(f.flight_date));

    tbody.appendChild(tr);
  }
}

function timeInputCell(row, col){
  const td = document.createElement("td");
  const input = document.createElement("input");
  input.type = "time";
  input.className = "time";
  input.value = fmtTime(row[col]);
  input.addEventListener("change", async (e)=>{
    const t = e.target.value; // "HH:MM"
    const newTs = applyTimeToTimestamp(row[col], t, row.flight_date);
    row[col] = newTs;
    await updateCell(row.id, { [col]: newTs });
  });
  td.appendChild(input);
  return td;
}

function numInputCell(row, col, cls=""){
  const td = document.createElement("td");
  const input = document.createElement("input");
  input.type = "number";
  input.className = cls;
  input.value = row[col] ?? "";
  input.addEventListener("change", async (e)=>{
    const v = e.target.value === "" ? null : Number(e.target.value);
    row[col] = v;
    await updateCell(row.id, { [col]: v });
  });
  td.appendChild(input);
  return td;
}

function textInputCell(row, col, cls=""){
  const td = document.createElement("td");
  const input = document.createElement("input");
  input.type = "text";
  input.className = cls;
  input.value = row[col] ?? "";
  input.addEventListener("change", async (e)=>{
    const v = e.target.value.trim() === "" ? null : e.target.value;
    row[col] = v;
    await updateCell(row.id, { [col]: v });
  });
  td.appendChild(input);
  return td;
}

/*** Tabs ***/
function renderTabs(){
  const tabsEl = document.getElementById("tabs");
  tabsEl.innerHTML = "";
  terminals.forEach(t=>{
    const b = document.createElement("div");
    b.className = "tab" + (t===activeTerminal ? " active":"");
    b.textContent = t;
    b.onclick = ()=>{ activeTerminal = t; renderTabs(); loadFlights(); };
    tabsEl.appendChild(b);
  });
}

/*** Realtime (تحديث لحظي للجميع) ***/
function setupRealtime(){
  supabase.channel("flights-changes")
    .on("postgres_changes",
        { event:"*", schema:"public", table:"flights" },
        (payload)=>{
          // أبسط حل: إعادة تحميل البيانات عند أي تغيير
          loadFlights();
        })
    .subscribe();
}

/*** Init ***/
document.getElementById("refreshBtn").onclick = loadFlights;
renderTabs();
loadFlights();
setupRealtime();
</script>

</body>
</html>