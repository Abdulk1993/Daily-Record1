<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flight Baggage & LB Monitor</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --line:#e5e9f0;
      --text:#1f2937;
      --muted:#6b7280;
      --blue:#2563eb;
      --blue-2:#1d4ed8;
      --green:#10b981;
      --red:#ef4444;
      --amber:#f59e0b;
      --chip:#eef2ff;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:16px 18px 8px;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{
      font-size:20px;
      margin:0;
      font-weight:700;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      flex-wrap:wrap;
    }
    button{
      background:var(--blue);
      color:white;
      border:0;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 1px 0 rgba(0,0,0,.05);
    }
    button:hover{ background:var(--blue-2); }
    .count{ font-size:14px; color:var(--muted); }

    .tabs{
      display:flex;
      gap:8px;
      padding:0 18px 10px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 12px;
      border-radius:999px;
      background:#e9edf5;
      color:#111827;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{ background:var(--blue); color:white; }

    .wrap{
      padding:0 12px 24px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      overflow:auto;
      box-shadow:0 8px 30px rgba(31,41,55,.06);
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:1250px;
      table-layout:fixed;
      font-size:12px;
    }
    thead th{
      position:sticky; top:0;
      background:#eaf1ff;
      border-bottom:1px solid var(--line);
      padding:8px 6px;
      text-align:center;
      font-weight:800;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:6px;
      text-align:center;
      white-space:nowrap;
      vertical-align:middle;
    }
    tbody tr:hover{ background:#f9fbff; }

    /* عرض الأعمدة — مهم عشان المسافات تصير مرتبة */
    col.w-flt{ width:70px }
    col.w-tep{ width:50px }
    col.w-time{ width:60px }
    col.w-small{ width:48px }     /* ULD/BC/PLT/D/W */
    col.w-num{ width:60px }       /* biggest numeric */
    col.w-remark{ width:160px }   /* remarks */

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-weight:800;
      font-size:11px;
      background:var(--chip);
    }
    .pill.green{ background:#dcfce7; color:#166534; }
    .pill.red{ background:#fee2e2; color:#991b1b; }
    .pill.amber{ background:#fef3c7; color:#92400e; }

    input.cell{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--line);
      border-radius:8px;
      padding:4px 6px;
      font-size:12px;
      text-align:center;
      background:white;
    }
    input.cell:focus{
      outline:none;
      border-color:var(--blue);
      box-shadow:0 0 0 2px rgba(37,99,235,.15);
    }
    input.cell[disabled]{
      background:#f3f4f6;
      color:#6b7280;
      cursor:not-allowed;
    }

    .muted{ color:var(--muted); }

    .footer{
      padding:8px 18px;
      font-size:11px;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>Flight Baggage & LB Monitor</h1>
      <div class="subtitle">Live daily record from Supabase — filter by terminal and export CSV</div>
    </div>
    <div class="topbar">
      <button id="refreshBtn">Refresh data</button>
      <div class="count" id="countLabel">Flights: 0</div>
      <button id="exportBtn" style="margin-left:auto;">Export CSV</button>
    </div>
  </header>

  <div class="tabs" id="tabs"></div>

  <div class="wrap">
    <div class="card">
      <table id="tbl">
        <colgroup>
          <col class="w-flt">
          <col class="w-tep">
          <col class="w-time">
          <col class="w-time">
          <col class="w-small">
          <col class="w-small">
          <col class="w-small">
          <col class="w-small">

          <col class="w-time">  <!-- F ULD -->
          <col class="w-time">  <!-- F BAG -->
          <col class="w-time">  <!-- L ULD -->
          <col class="w-time">  <!-- L BAG -->

          <col class="w-small"> <!-- ULD -->
          <col class="w-small"> <!-- BC -->
          <col class="w-small"> <!-- PLT -->
          <col class="w-small"> <!-- PAX (read only) -->
          <col class="w-small"> <!-- D -->
          <col class="w-small"> <!-- W -->

          <col class="w-small"> <!-- Date (read only) -->
          <col class="w-num">   <!-- TERMINATED BAGS -->
          <col class="w-num">   <!-- DOMESTIC TRANSIT -->
          <col class="w-num">   <!-- INTERNATIONAL TRANSIT -->

          <col class="w-remark"> <!-- DROP 1 -->
          <col class="w-remark"> <!-- DROP 2 -->
          <col class="w-remark"> <!-- DROP 3 -->
          <col class="w-remark"> <!-- ADDITIONAL -->
        </colgroup>

        <thead>
          <tr>
            <th>FLT</th>
            <th>TEP</th>
            <th>STA</th>
            <th>ATA</th>
            <th>BDY</th>
            <th>TAR</th>
            <th>ORG</th>
            <th>Belt</th>

            <th>F ULD</th>
            <th>F BAG</th>
            <th>L ULD</th>
            <th>L BAG</th>

            <th>ULD</th>
            <th>BC</th>
            <th>PLT</th>
            <th>PAX</th>
            <th>D</th>
            <th>W</th>

            <th>Date</th>
            <th>TERMINATED BAGS</th>
            <th>DOMESTIC TRANSIT</th>
            <th>INTERNATIONAL TRANSIT</th>

            <th>DROP LIST REMARK 1</th>
            <th>DROP LIST REMARK 2</th>
            <th>DROP LIST REMARK 3</th>
            <th>Additional remark</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    Changes save automatically. Realtime enabled for multi-user editing.
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * 1) CONFIG
     ***********************/
    const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // اسم الـ view اللي تقرأ منه
    const VIEW_NAME = "daily_record";  // نفس اللي سويته في SQL

    // الأعمدة اللي تبيها editable
    const EDITABLE_FIELDS = [
      "f_uld","f_bag","l_uld","l_bag",
      "uld","bc","plt","d","w",
      "terminated_bags","domestic_transit","international_transit",
      "drop_list_remark1","drop_list_remark2","drop_list_remark3",
      "additional_remark"
    ];

    const TIME_FIELDS = ["f_uld","f_bag","l_uld","l_bag"]; // timestamps لكن نعرض HH:MM
    const NUMBER_FIELDS = [
      "uld","bc","plt","d","w",
      "terminated_bags","domestic_transit","international_transit"
    ];
    const TEXT_FIELDS = [
      "drop_list_remark1","drop_list_remark2","drop_list_remark3","additional_remark"
    ];

    // فلاتر التيرمنال
    const TERMINALS = ["ALL","T1","T3","T4"];

    /***********************
     * 2) STATE
     ***********************/
    let allRows = [];
    let activeTerminal = "ALL";
    let realtimeChannel = null;
    let lastRenderKey = "";

    /***********************
     * 3) HELPERS
     ***********************/
    function pad2(n){ return String(n).padStart(2,"0"); }

    function formatTimeFromTimestamp(ts) {
      if(!ts) return "";
      const d = new Date(ts);
      if (isNaN(d)) return "";
      return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
    }

    // نحول HH:MM إلى timestamp based on flight_date عشان ما يصير 00:00
    function mergeDateAndTime(flight_date, hhmm){
      if(!flight_date || !hhmm) return null;
      const [hh,mm] = hhmm.split(":").map(Number);
      const base = new Date(flight_date + "T00:00:00");
      base.setHours(hh,mm,0,0);
      // نخزن كـ ISO بدون timezone offset (timestamp without tz)
      const iso = base.getFullYear()+"-"+pad2(base.getMonth()+1)+"-"+pad2(base.getDate())+
                  "T"+pad2(base.getHours())+":"+pad2(base.getMinutes())+":00";
      return iso;
    }

    function csvEscape(v){
      if(v == null) return "";
      const s = String(v).replace(/"/g,'""');
      return `"${s}"`;
    }

    /***********************
     * 4) FETCH
     ***********************/
    async function fetchRows(){
      const { data, error } = await supabase
        .from(VIEW_NAME)
        .select("*")
        .order("sta",{ascending:true});

      if(error){
        console.error(error);
        alert("Error fetching data from Supabase");
        return [];
      }
      return data || [];
    }

    /***********************
     * 5) UPDATE CELL (auto-save)
     ***********************/
    async function updateFlight(id, patch){
      const { error } = await supabase
        .from("flights")
        .update(patch)
        .eq("id", id);

      if(error){
        console.error(error);
        alert("Save failed: " + error.message);
        throw error;
      }
    }

    /***********************
     * 6) RENDER
     ***********************/
    function renderTabs(){
      const tabsEl = document.getElementById("tabs");
      tabsEl.innerHTML = "";
      TERMINALS.forEach(t=>{
        const el = document.createElement("div");
        el.className = "tab " + (activeTerminal===t ? "active":"");
        el.textContent = (t==="ALL") ? "ALL (All terminals)" : t;
        el.onclick = ()=>{
          activeTerminal = t;
          renderTable();
          renderTabs();
        };
        tabsEl.appendChild(el);
      });
    }

    function renderTable(){
      const tbody = document.getElementById("tbody");

      const rows = activeTerminal==="ALL"
        ? allRows
        : allRows.filter(r => (r.terminal||r.tep) === activeTerminal);

      document.getElementById("countLabel").textContent =
        `Flights: ${rows.length} (${activeTerminal==="ALL"?"ALL terminals":"Terminal "+activeTerminal})`;

      // تجنب رندر بدون سبب
      const key = activeTerminal + "|" + rows.map(r=>r.id+":"+r.updated_at).join(",");
      if(key === lastRenderKey) return;
      lastRenderKey = key;

      tbody.innerHTML = "";

      rows.forEach(row=>{
        const tr = document.createElement("tr");

        // helper لصناعة td عادي
        function tdText(val, className=""){
          const td = document.createElement("td");
          if(className) td.className=className;
          td.textContent = val ?? "";
          return td;
        }

        // helper لصناعة input قابل للتعديل
        function tdInput(field, type){
          const td = document.createElement("td");
          const input = document.createElement("input");
          input.className="cell";
          input.dataset.id = row.id;
          input.dataset.field = field;

          if(type==="time"){
            input.type="time";
            input.step=60;
            input.value = formatTimeFromTimestamp(row[field]);
          } else if(type==="number"){
            input.type="number";
            input.value = row[field] ?? "";
          } else {
            input.type="text";
            input.value = row[field] ?? "";
          }

          // autosave on change / blur
          const save = async ()=>{
            let value = input.value;
            const patch = {};

            if(type==="time"){
              const merged = mergeDateAndTime(row.flight_date, value);
              patch[field] = merged; // ISO string
              input.value = value;   // يبقى HH:MM
            } else if(type==="number"){
              patch[field] = value === "" ? null : Number(value);
            } else {
              patch[field] = value === "" ? null : value;
            }

            // optimistic update locally
            row[field] = patch[field];

            try{
              await updateFlight(row.id, patch);
            }catch(e){
              // في حالة فشل نرجع القيمة القديمة
              renderTable();
            }
          };

          input.addEventListener("change", save);
          input.addEventListener("blur", save);

          td.appendChild(input);
          return td;
        }

        // الأعمدة الثابتة
        tr.appendChild(tdText(row.flt));
        tr.appendChild(tdText(row.tep || row.terminal));
        tr.appendChild(tdText(formatTimeFromTimestamp(row.sta)));
        tr.appendChild(tdText(formatTimeFromTimestamp(row.ata)));
        tr.appendChild(tdText(row.bdy));
        tr.appendChild(tdText(row.tar));
        tr.appendChild(tdText(row.org));
        tr.appendChild(tdText(row.belt));

        // time editable
        tr.appendChild(tdInput("f_uld","time"));
        tr.appendChild(tdInput("f_bag","time"));
        tr.appendChild(tdInput("l_uld","time"));
        tr.appendChild(tdInput("l_bag","time"));

        // numeric editable
        tr.appendChild(tdInput("uld","number"));
        tr.appendChild(tdInput("bc","number"));
        tr.appendChild(tdInput("plt","number"));

        // pax read-only
        tr.appendChild(tdText(row.pax));

        tr.appendChild(tdInput("d","number"));
        tr.appendChild(tdInput("w","number"));

        // date read-only
        tr.appendChild(tdText(row.flight_date));

        tr.appendChild(tdInput("terminated_bags","number"));
        tr.appendChild(tdInput("domestic_transit","number"));
        tr.appendChild(tdInput("international_transit","number"));

        tr.appendChild(tdInput("drop_list_remark1","text"));
        tr.appendChild(tdInput("drop_list_remark2","text"));
        tr.appendChild(tdInput("drop_list_remark3","text"));
        tr.appendChild(tdInput("additional_remark","text"));

        tbody.appendChild(tr);
      });
    }

    /***********************
     * 7) EXPORT CSV
     ***********************/
    function exportCSV(){
      const rows = activeTerminal==="ALL"
        ? allRows
        : allRows.filter(r => (r.terminal||r.tep) === activeTerminal);

      const headers = [
        "flt","tep","sta","ata","bdy","tar","org","belt",
        "f_uld","f_bag","l_uld","l_bag",
        "uld","bc","plt","pax","d","w","flight_date",
        "terminated_bags","domestic_transit","international_transit",
        "drop_list_remark1","drop_list_remark2","drop_list_remark3","additional_remark"
      ];

      const csv =
        headers.join(",") + "\n" +
        rows.map(r=>{
          return headers.map(h=>{
            if(TIME_FIELDS.includes(h)) return csvEscape(formatTimeFromTimestamp(r[h]));
            return csvEscape(r[h]);
          }).join(",");
        }).join("\n");

      const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url;
      a.download = `daily_record_${activeTerminal}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    /***********************
     * 8) REALTIME (multi-user like Excel)
     ***********************/
    function setupRealtime(){
      if(realtimeChannel) supabase.removeChannel(realtimeChannel);

      realtimeChannel = supabase
        .channel("flights-realtime")
        .on(
          "postgres_changes",
          { event:"*", schema:"public", table:"flights" },
          payload=>{
            const newRow = payload.new;
            if(!newRow?.id) return;

            // نحدّث الـ state
            const idx = allRows.findIndex(r=>r.id===newRow.id);
            if(idx>=0){
              allRows[idx] = { ...allRows[idx], ...newRow };
            }else{
              // لو انضافت رحلة جديدة
              allRows.push(newRow);
            }
            renderTable();
          }
        )
        .subscribe();
    }

    /***********************
     * 9) INIT
     ***********************/
    async function init(){
      renderTabs();
      document.getElementById("refreshBtn").onclick = async ()=>{
        allRows = await fetchRows();
        renderTable();
      };
      document.getElementById("exportBtn").onclick = exportCSV;

      allRows = await fetchRows();
      renderTable();
      setupRealtime();
    }

    init();
  </script>
</body>
</html>